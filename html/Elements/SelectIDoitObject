<div id="i-doit-objectbrowser" style="position: relative; min-width: 400px;">
    <div id="data-store" style="display:none;"></div>
	<div id="i-doit-browser-notice" class="ui-corner-all">Bitte wählen Sie einen Mandanten aus.</div>
    <div id="i-doit-objectbrowser-content" style="display:none;">
        <ul>
            <li><a href="#tab-objectview">Objektansicht</a></li>
            <li><a href="#tab-treeview">Baumansicht</a></li>
            <li><a href="#tab-itemview">Gewählte Objekte</a></li>
        </ul>

        <a href="<% RT->Config->Get('IDoitURL') %>" title="Go to i-doit" target="_blank">
			<img src="<% RT->Config->Get('WebPath') %>/NoAuth/images/i-doit.png" alt="i-doit" style="position: absolute; top: 5px; right: 8px; height: 28px;" />
		</a>

        <img id="loading-screen" src="<% RT->Config->Get('WebPath') %>/NoAuth/images/ajaxload.gif" alt="Loading" height="32" width="32" style="position: absolute; opacity: 0; z-index: 100; right: 80px; top: 5px;" />

        <div id="tab-objectview">
            Objekt Typ <select class="object-type"></select><br />
            <table class="object-table" style="width:100%;">
                <thead>
                    <tr>
                        <th width="5%"></th>
                        <th width="15%">ID</th>
                        <th width="80%">Name</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div id="tab-treeview">
            <div class="workplaces"></div>
            <span id="requestor-reload">Neu laden</span>
        </div>
        <div id="tab-itemview">
            Ausgewählte Objekte
            <table class="object-table" style="width:100%;">
                <thead>
                    <tr>
                        <th width="10%">Aktion</th>
                        <th width="10%">ID</th>
                        <th width="40%">Name</th>
                        <th width="40%">Typ</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="text/javascript">
// Global variables (without "var").
api_url = '<% $IDoitAPI %>';
api_lang = '<% $IDoitLanguage %>';
api_user = '<% $IDoitUser %>';
api_password = '<% $IDoitPassword %>';
api_mandator = 0;
api_default_mandator = <% $IDoitDefaultMandator %>;
api_default_view = '<% $IDoitView %>';

show_custom_fields = <% $IDoitShowCustomFields %>;

idoit_url = '<% RT->Config->Get('IDoitURL') %>';

browser_preselection_field = 'textarea[name="<% $IDoitObjects %>"]';
browser_mandator_field = 'select[name="<% $IDoitMandator %>"]';

current_objectview_data = {};
current_treeview_data = {};

initialized = false;

datatable_lang = {
    "sProcessing":   "Bitte warten...",
    "sLengthMenu":   "_MENU_ Einträge anzeigen",
    "sZeroRecords":  "Keine Einträge vorhanden.",
    "sInfo":         "_START_ bis _END_ von _TOTAL_ Einträgen",
    "sInfoEmpty":    "0 bis 0 von 0 Einträgen",
    "sInfoFiltered": "(gefiltert von _MAX_ Einträgen)",
    "sInfoPostFix":  "",
    "sSearch":       "Suchen",
    "sUrl":          "",
    "oPaginate": {
        "sFirst":    "&laquo;",
        "sPrevious": "&lsaquo;",
        "sNext":     "&rsaquo;",
        "sLast":     "&raquo;"
    }
};

objectbrowser_lang = {
	"LC_PLEASE_SELECT_MANDATOR": "Bitte wählen Sie einen Mandanten aus.",
	"LC_ERR_LOADING_OBJ_TYPES": "Error while loading object-types.",
	"LC_ERR_LOADING_OBJECTS_BY_OBJ_TYPE": "Error while loading objects by object-type",
	"LC_ERR_LOADING_OBJECTS_BY_EMAIL": "Error while loading objects by email.",
	"LC_ERR_LOADING_OBJECTS_BY_PRESELECTION": "Error while preselecting objects."
};
</script>

<script type="text/javascript" src="<% RT->Config->Get('WebPath') %>/NoAuth/js/i-doit-objectbrowser.js"></script>

<%INIT>
use Switch;

$IDoitURL = RT->Config->Get('IDoitURL');
unless($IDoitURL) {
    my $msg = loc('URL for i-doit is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}

$IDoitAPI = RT->Config->Get('IDoitAPI');
unless($IDoitAPI) {
    my $msg = loc('URL for i-doit\'s API is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}

$IDoitLanguage = RT->Config->Get('IDoitLanguage');
unless($IDoitLanguage) {
    my $msg = loc('Language for i-doit\'s API is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}

$IDoitUser = RT->Config->Get('IDoitUser');
unless($IDoitUser) {
    my $msg = loc('User for i-doit\'s API is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}

$IDoitPassword = RT->Config->Get('IDoitPassword');
unless($IDoitPassword) {
    my $msg = loc('Password for i-doit\'s API is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}

my $cfMandator = 'i-doit mandator';
my $cf = RT::CustomField->new($RT::SystemUser);
$cf->LoadByNameAndQueue(Name => $cfMandator, Queue => '0');
unless($cf->id) {
    $$skip_create = 1;
    push @{$results}, loc('Custom field ' . $cfMandator . ' does not exist.');
    my $msg = loc('URL for i-doit\'s API is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}
$IDoitMandator = 'Object-RT::Ticket--CustomField-' . $cf->id . '-Values';

my $cfObjects = 'i-doit objects';
$cf = RT::CustomField->new($RT::SystemUser);
$cf->LoadByNameAndQueue(Name => $cfObjects, Queue => '0');
unless($cf->id) {
    $$skip_create = 1;
    push @{$results}, loc('Custom field ' . $cfObjects . ' does not exist.');
    my $msg = loc('URL for i-doit\'s API is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}
$IDoitObjects = 'Object-RT::Ticket--CustomField-' . $cf->id . '-Values';

$IDoitDefaultMandator = RT->Config->Get('IDoitDefaultMandator');
unless($IDoitDefaultMandator) {
    $IDoitDefaultMandator = -1;
}

$IDoitDefaultView = RT->Config->Get('IDoitDefaultView');
unless($IDoitDefaultView) {
    my $msg = loc('Default view for i-doit\'s API is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}
switch ($IDoitDefaultView) {
    case 'object' { $IDoitView = 0; }
    case 'tree' { $IDoitView = 1; }
    case 'item' { $IDoitView = 2; }
}

$IDoitShowCustomFields = RT->Config->Get('IDoitShowCustomFields');
</%INIT>

<%ARGS>
$skip_create => undef
$results => undef

$IDoitURL => undef
$IDoitAPI => undef
$IDoitLanguage => undef
$IDoitUser => undef
$IDoitPassword => undef
$IDoitMandator => undef
$IDoitObjects => undef
$IDoitDefaultMandator => undef
$IDoitDefaultView => undef
$IDoitView => undef
$IDoitShowCustomFields => undef

# TODO Make field for email addresses configurable (current status: 'Requestors').
</%ARGS>
